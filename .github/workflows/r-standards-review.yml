name: R Package Standards Review

on:
  workflow_call:
    inputs:
      fail_on_violations:
        description: 'Fail the workflow if violations found'
        type: boolean
        default: true
      post_comment:
        description: 'Post review as PR comment'
        type: boolean
        default: true
    outputs:
      has_violations:
        description: 'Whether violations were detected'
        value: ${{ jobs.review.outputs.has_violations }}
      violation_count:
        description: 'Number of violations found'
        value: ${{ jobs.review.outputs.violation_count }}
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      GH_PAT:
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    outputs:
      has_violations: ${{ steps.parse-results.outputs.has_violations }}
      violation_count: ${{ steps.parse-results.outputs.violation_count }}

    # NOTE: Permissions must be set in the caller workflow, not here
    # Reusable workflows cannot have job-level permissions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch checklist from .agents
        id: read-checklist
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          CHECKLIST=$(gh api repos/artalytics/.agents/contents/_prompt/check-r-pkg-standards.md \
            --jq '.content' | base64 -d) || {
            echo "::error::Failed to fetch checklist from .agents"
            exit 1
          }
          {
            echo 'CHECKLIST<<EOF'
            echo "$CHECKLIST"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
          else
            BASE_SHA=${{ github.event.before }}
            HEAD_SHA=${{ github.sha }}
          fi

          CHANGED=$(git diff --name-only $BASE_SHA $HEAD_SHA -- \
            '*.R' '*.Rmd' '*.qmd' \
            'DESCRIPTION' 'NAMESPACE' '_pkgdown.yml' 'README.md' \
            'man/*' 'vignettes/*' 'tests/*' 2>/dev/null || echo "")

          if [ -z "$CHANGED" ]; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "any_changed=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no relevant changes
        if: steps.changed-files.outputs.any_changed != 'true'
        id: skip-review
        run: |
          echo "No R package files changed. Skipping review."
          echo "has_violations=false" >> $GITHUB_OUTPUT
          echo "violation_count=0" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          additional_permissions: |
            actions: read
          prompt: |
            You are an R package code reviewer enforcing organizational standards.

            ## Standards Checklist

            ${{ steps.read-checklist.outputs.CHECKLIST }}

            ---

            ## Review Instructions

            1. Review ONLY these changed files:
            ```
            ${{ steps.changed-files.outputs.files }}
            ```

            2. Read each file and check against ALL rules in the checklist.

            3. For EACH violation, output in this EXACT format (required for auto-fix pipeline):
            ```
            ---VIOLATION-START---
            RULE_ID: [e.g., NATIVE-PIPE]
            RULE_TEXT: [Full rule text from checklist]
            FILE: [exact/path/to/file.R]
            LINE_START: [number]
            LINE_END: [number]
            CODE_BEFORE: |
              [exact code snippet that violates the rule]
            CODE_AFTER: |
              [corrected code snippet]
            EXPLANATION: [Why this violates the rule and how the fix resolves it]
            SEVERITY: [critical|warning|style]
            AUTO_FIXABLE: [true|false]
            ---VIOLATION-END---
            ```

            4. After all violations, provide summary:
            ```
            ---SUMMARY-START---
            TOTAL_VIOLATIONS: [number]
            CRITICAL_COUNT: [number]
            WARNING_COUNT: [number]
            STYLE_COUNT: [number]
            AUTO_FIXABLE_COUNT: [number]
            FILES_REVIEWED: [comma-separated list]
            FILES_WITH_VIOLATIONS: [comma-separated list]
            PASSING_RULES: [number]/[total]
            ---SUMMARY-END---
            ```

            5. If NO violations found, output:
            ```
            ---SUMMARY-START---
            TOTAL_VIOLATIONS: 0
            STATUS: PASSING
            FILES_REVIEWED: [comma-separated list]
            ---SUMMARY-END---
            ```

      - name: Parse review results
        if: steps.changed-files.outputs.any_changed == 'true'
        id: parse-results
        run: |
          RESPONSE='${{ steps.claude-review.outputs.response }}'

          VIOLATION_COUNT=$(echo "$RESPONSE" | grep -oP 'TOTAL_VIOLATIONS: \K\d+' || echo "0")

          if [ "$VIOLATION_COUNT" -gt 0 ]; then
            echo "has_violations=true" >> $GITHUB_OUTPUT
          else
            echo "has_violations=false" >> $GITHUB_OUTPUT
          fi

          echo "violation_count=$VIOLATION_COUNT" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: |
          inputs.post_comment == true &&
          steps.changed-files.outputs.any_changed == 'true' &&
          github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const response = String.raw`${{ steps.claude-review.outputs.response }}`;
            const hasViolations = '${{ steps.parse-results.outputs.has_violations }}' === 'true';
            const violationCount = '${{ steps.parse-results.outputs.violation_count }}';

            const header = hasViolations
              ? `## ❌ R Package Standards Review\n\n**${violationCount} violation(s) found.** Please address before merging.\n\n`
              : '## ✅ R Package Standards Review\n\nAll checks passed!\n\n';

            const body = header + '```\n' + response + '\n```';

            // Find and update existing comment or create new one
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.data.find(c =>
              c.body.includes('R Package Standards Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

      - name: Save review artifact
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          mkdir -p review-output
          cat << 'ARTIFACT_EOF' > review-output/review-report.txt
          ${{ steps.claude-review.outputs.response }}
          ARTIFACT_EOF

          echo '${{ steps.parse-results.outputs.violation_count }}' > review-output/violation-count.txt
          echo '${{ steps.changed-files.outputs.files }}' > review-output/changed-files.txt

      - name: Upload review artifact
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: r-standards-review-${{ github.event.pull_request.number || github.run_id }}
          path: review-output/
          retention-days: 30

      - name: Set final outputs for skipped review
        if: steps.changed-files.outputs.any_changed != 'true'
        run: |
          echo "has_violations=false" >> $GITHUB_OUTPUT
          echo "violation_count=0" >> $GITHUB_OUTPUT

      - name: Fail on violations
        if: |
          inputs.fail_on_violations == true &&
          steps.parse-results.outputs.has_violations == 'true'
        run: |
          echo "::error::R package standards violations found (${{ steps.parse-results.outputs.violation_count }}). See PR comment for details."
          exit 1
