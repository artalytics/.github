name: "Sync: Build Info"

# Reusable workflow to sync R package DESCRIPTION to artalytics/build-info
# Called by individual R package repositories on push to main

on:
  workflow_call:
    secrets:
      GH_PAT:
        required: true
        description: "Personal access token with repo scope for pushing to build-info"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Validate and extract package info
        id: pkg
        run: |
          # Check DESCRIPTION exists
          if [ ! -f "DESCRIPTION" ]; then
            echo "::error::No DESCRIPTION file found in repository root"
            exit 1
          fi

          # Extract package metadata
          PKG_NAME=$(grep "^Package:" DESCRIPTION | sed 's/Package:[[:space:]]*//')
          PKG_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version:[[:space:]]*//')
          PKG_TITLE=$(grep "^Title:" DESCRIPTION | sed 's/Title:[[:space:]]*//')
          REPO_NAME="${{ github.event.repository.name }}"

          # Check for template placeholders (fail if package not configured)
          if [[ "$PKG_NAME" == *"{"* ]] || [[ "$PKG_NAME" == *"}"* ]]; then
            echo "::error::Package name contains template placeholders: $PKG_NAME"
            echo "::error::Please update DESCRIPTION with actual package information before pushing to main."
            exit 1
          fi

          if [[ "$PKG_TITLE" == *"{"* ]] || [[ "$PKG_TITLE" == *"}"* ]]; then
            echo "::error::Package title contains template placeholders: $PKG_TITLE"
            echo "::error::Please update DESCRIPTION with actual package information before pushing to main."
            exit 1
          fi

          # Validate package name format (letters, numbers, dots; must start with letter)
          if ! [[ "$PKG_NAME" =~ ^[a-zA-Z][a-zA-Z0-9.]*$ ]]; then
            echo "::error::Invalid package name format: $PKG_NAME"
            echo "::error::R package names must start with a letter and contain only letters, numbers, and dots."
            exit 1
          fi

          # Output values
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "pkg_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "pkg_title=$PKG_TITLE" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

          echo "üì¶ Package: $PKG_NAME v$PKG_VERSION"
          echo "üìÇ Repository: $REPO_NAME"

          if [ "$PKG_NAME" != "$REPO_NAME" ]; then
            echo "::notice::Package name ($PKG_NAME) differs from repo name ($REPO_NAME)"
          fi

      - name: Checkout build-info repository
        uses: actions/checkout@v4
        with:
          repository: artalytics/build-info
          path: build-info
          token: ${{ secrets.GH_PAT }}

      - name: Update package DESCRIPTION in build-info
        run: |
          PKG_NAME="${{ steps.pkg.outputs.pkg_name }}"
          REPO_NAME="${{ steps.pkg.outputs.repo_name }}"

          # Create/update package directory using package name (canonical)
          mkdir -p build-info/package/$PKG_NAME
          cp DESCRIPTION build-info/package/$PKG_NAME/

          echo "üìÅ Updated: package/$PKG_NAME/DESCRIPTION"

          # Clean up old directory if repo was renamed
          if [ "$PKG_NAME" != "$REPO_NAME" ] && [ -d "build-info/package/$REPO_NAME" ]; then
            echo "üßπ Removing deprecated directory: package/$REPO_NAME"
            rm -rf "build-info/package/$REPO_NAME"
          fi

      - name: Commit and push changes
        working-directory: build-info
        run: |
          git config user.email "bobby@artalytics.app"
          git config user.name "Bobby Fatemi"

          git add package/

          if git diff --cached --quiet; then
            echo "‚úÖ No changes detected - DESCRIPTION already up to date."
          else
            PKG_NAME="${{ steps.pkg.outputs.pkg_name }}"
            PKG_VERSION="${{ steps.pkg.outputs.pkg_version }}"
            git commit -m "Update $PKG_NAME to v$PKG_VERSION"
            git push
            echo "‚úÖ Pushed DESCRIPTION update for $PKG_NAME v$PKG_VERSION"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
